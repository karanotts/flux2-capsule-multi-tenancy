---
apiVersion: batch/v1
kind: Job
metadata:
  labels:
    app: generator
  name: generator
  namespace: flux-system
spec:
  template:
    metadata:
      labels:
        app: generator
    spec:
      serviceAccountName: kustomize-controller # edit
      containers:
        - image: quay.io/maxgio92/proxy-kubeconfig-generator:0.1.0
          args:
            - --serviceaccount=gitops-reconciler
            - --namespace=dev-team
            - --server=https://capsule-proxy.capsule.svc:9001
            - --server-tls-secret-name=capsule-proxy
            - --server-tls-secret-namespace=capsule
          imagePullPolicy: IfNotPresent
          name: generator
          securityContext:
            allowPrivilegeEscalation: false
            runAsNonRoot: true
            seccompProfile:
              type: "RuntimeDefault"
            capabilities:
              drop:
              - ALL
      restartPolicy: OnFailure
